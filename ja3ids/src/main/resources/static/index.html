<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>JA3 IDS Live Dashboard</title>

    <!-- Spring Boot static paths -->
    <link rel="stylesheet" href="/css/dashboard.css">
    <script src="/libs/chart.min.js"></script>
</head>

<body>

<h1>ðŸš¨ JA3 IDS Live Dashboard</h1>

<!-- ================= STATUS CARD ================= -->
<div class="card">
    <div class="row"><span class="label">JA3 Hash:</span><span id="ja3" class="value">-</span></div>
    <div class="row"><span class="label">Hits:</span><span id="hits" class="value">-</span></div>
    <div class="row"><span class="label">Threat Level:</span><span id="threat" class="value">-</span></div>
    <div class="row"><span class="label">Status:</span><span id="status" class="value">-</span></div>
    <div class="row"><span class="label">Message:</span><span id="message" class="value">-</span></div>
</div>

<!-- ================= MAIN GRID ================= -->
<div class="main-grid">

    <!-- REAL-TIME FEED -->
    <div class="log-panel">
        <div class="log-title">ðŸŸ¢ REAL-TIME TRAFFIC FEED</div>
        <div id="logFeed" class="log-feed"></div>
    </div>

    <!-- CHARTS -->
    <div class="charts-grid">
        <div class="chart-card">
            <div class="chart-title">ðŸ“ˆ Threat Level Over Time</div>
            <canvas id="threatChart"></canvas>
        </div>

        <div class="chart-card">
            <div class="chart-title">ðŸ“Š Hits vs Threat Level</div>
            <canvas id="hitsThreatChart"></canvas>
        </div>
    </div>
</div>

<script>
    let threatChart, hitsChart;

    /* ================= INIT CHARTS ================= */
    function initCharts() {
        threatChart = new Chart(
            document.getElementById("threatChart").getContext("2d"),
            {
                type: "line",
                data: {
                    labels: [],
                    datasets: [{
                        label: "Threat Level",
                        data: [],
                        borderColor: "#ef4444",
                        backgroundColor: "rgba(239,68,68,0.25)",
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false
                }
            }
        );

        hitsChart = new Chart(
            document.getElementById("hitsThreatChart").getContext("2d"),
            {
                type: "line",
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: "Hits",
                            data: [],
                            borderColor: "#38bdf8",
                            backgroundColor: "rgba(56,189,248,0.25)",
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: "Threat Level",
                            data: [],
                            borderColor: "#f59e0b",
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false
                }
            }
        );
    }

    /* ================= UPDATE DASHBOARD ================= */
    async function updateDashboard() {
        try {
            const res = await fetch("/api/ja3/latest");
            if (!res.ok) return;

            const latest = await res.json();
            if (!latest || !latest.ja3Hash) return;

            // ---- STATUS CARD ----
            document.getElementById("ja3").textContent = latest.ja3Hash;
            document.getElementById("hits").textContent = latest.hits;
            document.getElementById("threat").textContent = latest.threatLevel;
            document.getElementById("message").textContent = latest.message || "-";

            const statusEl = document.getElementById("status");
            const rawStatus = (latest.status || "").toUpperCase();

            statusEl.textContent = rawStatus || "-";
            statusEl.classList.remove("OK", "WARNING", "BLOCKED");

            if (rawStatus.includes("OK")) statusEl.classList.add("OK");
            else if (rawStatus.includes("WARN")) statusEl.classList.add("WARNING");
            else if (rawStatus.includes("CRIT") || rawStatus.includes("BLOCK"))
                statusEl.classList.add("BLOCKED");

            // ---- REAL-TIME LOG FEED (FINAL TERMINAL STYLE) ----
            const logFeed = document.getElementById("logFeed");
            const time = new Date(latest.timestamp).toLocaleTimeString();

            let cls = "log-ok";
            if (latest.malicious) cls = "log-bad";
            else if (rawStatus.includes("WARN")) cls = "log-warn";

            const line = document.createElement("div");
            line.className = "log-line " + cls;
            line.textContent =
                `[${time}] IDS_KERNEL:\n` +
                JSON.stringify(latest);

            logFeed.appendChild(line);
            logFeed.scrollTop = logFeed.scrollHeight;

        } catch (e) {
            console.error("Dashboard update failed", e);
        }
    }

    /* ================= UPDATE CHARTS ================= */
    async function updateCharts() {
        try {
            const res = await fetch("/api/ja3/logs");
            if (!res.ok) return;

            const logs = await res.json();
            if (!Array.isArray(logs)) return;

            const recent = logs.slice(0, 15).reverse();

            threatChart.data.labels = [];
            threatChart.data.datasets[0].data = [];

            hitsChart.data.labels = [];
            hitsChart.data.datasets[0].data = [];
            hitsChart.data.datasets[1].data = [];

            recent.forEach(e => {
                const t = new Date(e.timestamp).toLocaleTimeString();
                threatChart.data.labels.push(t);
                threatChart.data.datasets[0].data.push(e.threatLevel);

                hitsChart.data.labels.push(t);
                hitsChart.data.datasets[0].data.push(e.hits);
                hitsChart.data.datasets[1].data.push(e.threatLevel);
            });

            threatChart.update();
            hitsChart.update();

        } catch (e) {
            console.error("Chart update failed", e);
        }
    }

    /* ================= START ================= */
    window.onload = () => {
        initCharts();
        updateDashboard();
        updateCharts();
        setInterval(() => {
            updateDashboard();
            updateCharts();
        }, 2000);
    };
</script>

</body>
</html>
